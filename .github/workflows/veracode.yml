name: Veracode Static Analysis Pipeline Scan 
on: 

  workflow_dispatch: 

  push: 

    branches: [ master ] 

  pull_request: 

    branches: [ master ] 

jobs: 

  build: 

    # The type of runner that the job will run on 

    runs-on: ubuntu-latest 

    steps: 

    - uses: actions/checkout@v2 

    # zip the project and move it to a staging directory 

    - name: Zip Project 

      run: zip -R project.zip '*.py' '*.js' '*.php' '*.ts' 

      env: 

      build-name: project.zip 

    - name: Archive package 

      uses: actions/upload-artifact@v2 

      with: 

        name: CodePackage 

        path: project.zip 

    
    pipeline-scan: 

    needs: build 
  runs-on: ubuntu-latest 
  container:  
   image: veracode/pipeline-scan:latest 
   options: --user root # our normal luser doesn't have privs to write to github directories 
  steps: 
      - name: Retrieve artifact 
  uses: actions/download-artifact@v2 
  with: 
    name: CodePackage
  - name: Pipeline Scan 

      run: | 

        java -jar /opt/veracode/pipeline-scan.jar --veracode_api_id="${{secrets.VERACODE_API_ID}}" --veracode_api_key="${{secrets.VERACODE_API_KEY}}" --fail_on_severity="Very High, High" --file="project.zip" --app_id="${{secrets.VERACODE_APP_ID}}" --json_output_file="results.json" 

      continue-on-error: true 


    - uses: actions/upload-artifact@v2 

      with: 

        name: ScanResults 

        path: results.json 
